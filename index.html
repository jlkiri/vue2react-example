<!DOCTYPE html>
<html>

<head>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
</head>

<body>
  <!-- consoleã®ä¸­ã§convertVueToReact(app)ã§Reactã«å¤‰æ›ã™ã‚‹ -->
  <div id="app">
    <p data-renders="count">{{ count }}</p>
    <button v-on:click="increase">Increase</button>
  </div>
  <script>
    var app = new Vue({
      el: "#app",
      data: {
        count: 1
      },
      methods: {
        increase: function () {
          this.count = this.count + 1;
          return this.count;
        }
      }
    });

    const convertVueToReact = function convertVueToReact(app) {
      // Reactç”¨ã®å¤–éƒ¨ã‚¹ãƒˆã‚¢
      const data = {
        ...app._data,
        ...app.$options.methods,
        _observers: [],
        _registerObservers: function _registerObservers(fn) {
          const len = this._observers.push(fn);
          return (function _unsubscribe() {
            this._observers = this._observers.filter((obs, i) => i !== len - 1);
          }).bind(this);
        },
        _broadcast: function _broadcast() {
          this._observers.forEach(fn => {
            fn(Object.entries(this));
          })
        }
      };

      // å†å¸°çš„ã«DOMã®ãƒ„ãƒªãƒ¼ã‚’å¤‰æ›ã™ã‚‹
      const buildTree = (node, state) => {
        if (!node.tag) {
          return node.text;
        }

        const root = {};
        root.listeners = {};
        root.children = [];

        if (node.children && node.children.length !== 0) {
          for (let child of node.children) {
            // ã“ã“ãŒå†å¸°çš„ãªå‡¦ç†
            root.children.push(buildTree(child, state));
          }
        }

        // ã‚¹ãƒ†ãƒ¼ãƒˆåæ˜ å¿…è¦ãªã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‹ã€ãã—ã¦ã‚¹ãƒ†ãƒ¼ãƒˆã®ä½•ã‚’åæ˜ ã™ã‚‹ã‹ã®ãƒ­ã‚¸ãƒƒã‚¯
        if (node.data.attrs && "data-renders" in node.data.attrs) {
          if (state) {
            root.value = state[node.data.attrs[`data-renders`]];
            // ã‚‚ã¨ã‚‚ã¨ã‚ã£ãŸå€¤ã‚’å‰Šé™¤ã™ã‚‹
            root.children = root.children.filter(child => typeof child !== "string");
          }
        }

        // Vueã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã«ç™»éŒ²ã—ã€å¤–éƒ¨ã‚¹ãƒˆã‚¢ã®æ›´æ–°ã¨åŒæ™‚ã«ã€
        // subscribeã—ãŸobserverã«æ›´æ–°ã‚’é€šçŸ¥ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
        if (node.data && node.data.on) {
          Object.keys(node.data.on).forEach(listener => {
            const name = node.data.on[listener].fns.name.split(" ")[1];

            const reactHandlerName = `on` +
              listener.charAt(0).toUpperCase() + listener.slice(1);

            root.listeners[reactHandlerName] = function () {
              data[name]();
              data._broadcast();
            };
          });
        }

        root.type = node.tag;

        return React.createElement(
          root.type,
          { ...root.listeners },
          root.value,
          ...root.children
        );
      };

      const App = () => {
        const [appState, setAppState] = React.useState(null);

        React.useEffect(() => {
          const unsubscribe = data._registerObservers(upd => {
            const cleanState = upd.filter(([key, val]) => key[0] !== "_");
            setAppState(Object.fromEntries(cleanState));
          });
          return unsubscribe;
        });

        React.useEffect(() => {
          if (appState) {
            console.log(`ðŸ”¥Updated in React: `, appState.count)
          }
        }, [appState]);

        return buildTree(app._vnode, appState);
      }

      const reactApp = React.createElement(App);

      ReactDOM.render(reactApp, document.querySelector("#app"));
    }
  </script>
</body>

</html>
